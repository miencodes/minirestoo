# ges, ini file konfigurasi yg bener.
# kita mulai langsung dari 'upstream', ga pake 'events' atau 'http'

upstream product_backend {
  server product-management:3002;
}

upstream inventory_backend {
  server inventory-management:3001;
}

upstream operasional_backend {
  server operasional:3003;
}

# Ini server utama kita
server {
  listen 80;

  # --- (BARU) Konfigurasi CORS ---
  # Alamat frontend kita (React)
  set $cors_origin "http://localhost:3000";

  # Header ini bilang "Browser, gue bolehin origin itu"
  add_header 'Access-Control-Allow-Origin' $cors_origin always;
  # Header ini bilang "Browser, gue bolehin metode POST, GET, dll"
  add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
  # Header ini bilang "Browser, gue bolehin header 'Content-Type', dll"
  add_header 'Access-Control-Allow-Headers' 'Content-Type,Authorization' always;

  # (PENTING) Browser bakal nanya dulu pake 'OPTIONS'
  # Kalo ada request OPTIONS, kita jawab 'OK' aja
  if ($request_method = 'OPTIONS') {
    return 204;
  }
  # --- Selesai Konfigurasi CORS ---


  # --- Routing (ini masih sama kayak tadi) ---
  location /api/products/ {
    proxy_pass http://product_backend/api/products/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location /api/inventory/ {
    proxy_pass http://inventory_backend/api/inventory/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location /api/orders/ {
    proxy_pass http://operasional_backend/api/orders/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}